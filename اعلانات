from telegram import Update, ReplyKeyboardMarkup
from telegram.ext import Updater, CommandHandler, MessageHandler, Filters, CallbackContext
import sqlite3

# Ø¥Ø¹Ø¯Ø§Ø¯ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
def init_db():
    conn = sqlite3.connect("bot_data.db")
    cursor = conn.cursor()
    cursor.execute("""
    CREATE TABLE IF NOT EXISTS users (
        user_id INTEGER PRIMARY KEY,
        username TEXT,
        points INTEGER DEFAULT 0
    )
    """)
    cursor.execute("""
    CREATE TABLE IF NOT EXISTS withdrawal_requests (
        user_id INTEGER,
        points INTEGER,
        info TEXT,
        status TEXT DEFAULT 'Pending'
    )
    """)
    conn.commit()
    conn.close()

# ÙˆØ¸ÙŠÙØ© Ù„Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
def add_user(user_id, username):
    conn = sqlite3.connect("bot_data.db")
    cursor = conn.cursor()
    cursor.execute("INSERT OR IGNORE INTO users (user_id, username) VALUES (?, ?)", (user_id, username))
    conn.commit()
    conn.close()

# ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ù‚Ø§Ø·
def update_points(user_id, points):
    conn = sqlite3.connect("bot_data.db")
    cursor = conn.cursor()
    cursor.execute("UPDATE users SET points = points + ? WHERE user_id = ?", (points, user_id))
    conn.commit()
    conn.close()

# Ø¬Ù„Ø¨ Ø§Ù„Ù†Ù‚Ø§Ø· Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
def get_points(user_id):
    conn = sqlite3.connect("bot_data.db")
    cursor = conn.cursor()
    cursor.execute("SELECT points FROM users WHERE user_id = ?", (user_id,))
    result = cursor.fetchone()
    conn.close()
    return result[0] if result else 0

# Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ Ø³Ø­Ø¨
def add_withdrawal_request(user_id, points, info):
    conn = sqlite3.connect("bot_data.db")
    cursor = conn.cursor()
    cursor.execute("INSERT INTO withdrawal_requests (user_id, points, info) VALUES (?, ?, ?)", (user_id, points, info))
    conn.commit()
    conn.close()

# Ø¹Ø±Ø¶ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨ (Ù„ØµØ§Ø­Ø¨ Ø§Ù„Ø¨ÙˆØª)
def get_withdrawal_requests():
    conn = sqlite3.connect("bot_data.db")
    cursor = conn.cursor()
    cursor.execute("SELECT * FROM withdrawal_requests WHERE status = 'Pending'")
    requests = cursor.fetchall()
    conn.close()
    return requests

# Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
def start(update: Update, context: CallbackContext) -> None:
    user_id = update.effective_user.id
    username = update.effective_user.username
    add_user(user_id, username)
    update.message.reply_text("Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ ÙÙŠ Ø¨ÙˆØª Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª! ğŸ‰\nØ§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£ÙˆØ§Ù…Ø±:\n/view_ad - Ù…Ø´Ø§Ù‡Ø¯Ø© Ø¥Ø¹Ù„Ø§Ù†\n/my_points - Ø¹Ø±Ø¶ Ù†Ù‚Ø§Ø·Ùƒ\n/withdraw - Ø·Ù„Ø¨ Ø³Ø­Ø¨ Ø§Ù„Ù†Ù‚Ø§Ø·")

def view_ad(update: Update, context: CallbackContext) -> None:
    user_id = update.effective_user.id
    # Ù…Ù†Ø­ Ù†Ù‚Ø§Ø· Ø¨Ø¹Ø¯ Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†
    update_points(user_id, 10)  # Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§ ÙŠÙ…Ù†Ø­ 10 Ù†Ù‚Ø§Ø·
    update.message.reply_text("ØªÙ…Øª Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†! ğŸ‰\nÙ„Ù‚Ø¯ Ø­ØµÙ„Øª Ø¹Ù„Ù‰ 10 Ù†Ù‚Ø§Ø·.")

def my_points(update: Update, context: CallbackContext) -> None:
    user_id = update.effective_user.id
    points = get_points(user_id)
    update.message.reply_text(f"Ù†Ù‚Ø§Ø·Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠØ©: {points} ğŸ†")

def withdraw(update: Update, context: CallbackContext) -> None:
    user_id = update.effective_user.id
    points = get_points(user_id)
    if points < 50:  # Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø³Ø­Ø¨
        update.message.reply_text("Ø¹Ø°Ø±Ù‹Ø§ØŒ ÙŠØ¬Ø¨ Ø£Ù† ØªÙ…ØªÙ„Ùƒ 50 Ù†Ù‚Ø·Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨.")
        return
    
    update.message.reply_text("Ø£Ø±Ø³Ù„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø³Ø­Ø¨ (Ù…Ø«Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø£Ùˆ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ):")

    context.user_data['awaiting_info'] = True

def handle_message(update: Update, context: CallbackContext) -> None:
    user_id = update.effective_user.id
    if context.user_data.get('awaiting_info'):
        info = update.message.text
        points = get_points(user_id)
        add_withdrawal_request(user_id, points, info)
        update_points(user_id, -points)  # Ø®ØµÙ… Ø§Ù„Ù†Ù‚Ø§Ø·
        context.user_data['awaiting_info'] = False
        update.message.reply_text("ØªÙ… ØªÙ‚Ø¯ÙŠÙ… Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨! âœ…")
    else:
        update.message.reply_text("Ù…Ø±Ø­Ø¨Ù‹Ø§! Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ù„ØªÙ†ÙÙŠØ° Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª.")

def admin_view_requests(update: Update, context: CallbackContext) -> None:
    if update.effective_user.username != "AdminUsername":  # Ø§Ø³ØªØ¨Ø¯Ù„ "AdminUsername" Ø¨Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù…Ùƒ
        update.message.reply_text("Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø± Ù…Ø®ØµØµ Ù„ØµØ§Ø­Ø¨ Ø§Ù„Ø¨ÙˆØª ÙÙ‚Ø·.")
        return

    requests = get_withdrawal_requests()
    if not requests:
        update.message.reply_text("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø³Ø­Ø¨ Ø­Ø§Ù„ÙŠÙ‹Ø§.")
    else:
        msg = "Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨:\n"
        for req in requests:
            msg += f"User ID: {req[0]}, Points: {req[1]}, Info: {req[2]}, Status: {req[3]}\n"
        update.message.reply_text(msg)

# Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯
def main():
    init_db()
    updater = Updater("PUT_YOUR_BOT_TOKEN_HERE")
    dispatcher = updater.dispatcher

    dispatcher.add_handler(CommandHandler("start", start))
    dispatcher.add_handler(CommandHandler("view_ad", view_ad))
    dispatcher.add_handler(CommandHandler("my_points", my_points))
    dispatcher.add_handler(CommandHandler("withdraw", withdraw))
    dispatcher.add_handler(CommandHandler("admin_view_requests", admin_view_requests))
    dispatcher.add_handler(MessageHandler(Filters.text & ~Filters.command, handle_message))

    updater.start_polling()
    updater.idle()

if __name__ == "__main__":
    main()
